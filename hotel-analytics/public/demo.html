<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel Analytics Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom CSS -->
<style>
:root {
    --sidebar-width: 250px;
    --primary-color: #2c3e50;
    --secondary-color: #34495e;
    --accent-color: #3498db;
    --text-light: #ecf0f1;
    --card-bg: #ffffff;
    --hover-color: #2980b9;
}

body {
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f5f6fa;
}

.dashboard-container {
    display: flex;
    min-height: 100vh;
}

/* Sidebar Styles */
.sidebar {
    width: var(--sidebar-width);
    background-color: var(--primary-color);
    color: var(--text-light);
    padding: 20px;
    position: fixed;
    height: 100vh;
    overflow-y: auto;
}

.sidebar-header {
    padding-bottom: 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    margin-bottom: 20px;
}

.filters {
    padding: 15px 0;
}

.filter-group {
    margin-bottom: 20px;
}

.filter-group label {
    display: block;
    margin-bottom: 5px;
    font-size: 0.9em;
}

/* Main Content Styles */
.main-content {
    flex: 1;
    margin-left: var(--sidebar-width);
    padding: 20px;
}

/* KPI Cards */
.kpi-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.kpi-card {
    background: var(--card-bg);
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    text-align: center;
    transition: transform 0.3s ease;
}

.kpi-card:hover {
    transform: translateY(-5px);
}

.kpi-card i {
    font-size: 2em;
    color: var(--accent-color);
    margin-bottom: 10px;
}

.kpi-card h4 {
    margin: 10px 0;
    font-size: 1em;
    color: var(--secondary-color);
}

.kpi-card p {
    font-size: 1.5em;
    font-weight: bold;
    margin: 0;
    color: var(--primary-color);
}

/* Charts Grid */
.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.chart-card {
    background: var(--card-bg);
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.chart-card h5 {
    margin-bottom: 15px;
    color: var(--secondary-color);
}

/* Table Styles */
.table-container {
    background: var(--card-bg);
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.table {
    margin: 0;
}

/* Loading Spinner */
.loading-spinner {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

/* Toast Styles */
.toast-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
}

/* Responsive Design */
@media (max-width: 768px) {
    .sidebar {
        width: 100%;
        height: auto;
        position: relative;
    }
    
    .main-content {
        margin-left: 0;
    }
    
    .charts-grid {
        grid-template-columns: 1fr;
    }
}
</style>
    <!-- Charts.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>Hotel Analytics</h3>
            </div>
            <div class="filters">
                <h4>Filters</h4>
                <div class="filter-group">
                    <label>City</label>
                    <select id="cityFilter" class="form-select">
                        <option value="all">All Cities</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Property</label>
                    <select id="propertyFilter" class="form-select">
                        <option value="all">All Properties</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Platform</label>
                    <select id="platformFilter" class="form-select">
                        <option value="all">All Platforms</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Date Range</label>
                    <select id="dateFilter" class="form-select">
                        <option value="all">All Dates</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- KPI Cards Row -->
            <div class="kpi-container">
                <div class="kpi-card">
                    <i class="fas fa-money-bill-wave"></i>
                    <h4>Total Revenue</h4>
                    <p id="totalRevenue">â‚¹0</p>
                </div>
                <div class="kpi-card">
                    <i class="fas fa-bed"></i>
                    <h4>Occupancy Rate</h4>
                    <p id="occupancyRate">0%</p>
                </div>
                <div class="kpi-card">
                    <i class="fas fa-star"></i>
                    <h4>Avg Rating</h4>
                    <p id="avgRating">0.0</p>
                </div>
                <div class="kpi-card">
                    <i class="fas fa-times-circle"></i>
                    <h4>Cancellation Rate</h4>
                    <p id="cancellationRate">0%</p>
                </div>
            </div>

            <!-- Charts Grid -->
            <div class="charts-grid">
                <!-- Revenue Trend -->
                <div class="chart-card">
                    <h5>Revenue Trend</h5>
                    <canvas id="revenueTrendChart"></canvas>
                </div>
                <!-- Occupancy by Room Type -->
                <div class="chart-card">
                    <h5>Occupancy by Room Type</h5>
                    <canvas id="occupancyChart"></canvas>
                </div>
                <!-- Booking Platform Distribution -->
                <div class="chart-card">
                    <h5>Booking Platform Distribution</h5>
                    <canvas id="platformChart"></canvas>
                </div>
                <!-- Rating Distribution -->
                <div class="chart-card">
                    <h5>Rating Distribution</h5>
                    <canvas id="ratingChart"></canvas>
                </div>
            </div>

            <!-- Detailed Stats Table -->
            <div class="table-container">
                <h5>Property Performance Details</h5>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Property</th>
                            <th>Revenue</th>
                            <th>Occupancy</th>
                            <th>Avg Rating</th>
                            <th>Cancellation %</th>
                        </tr>
                    </thead>
                    <tbody id="statsTable">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-spinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Feedback Toast -->
    <div class="toast-container">
        <div id="feedbackToast" class="toast" role="alert">
            <div class="toast-header">
                <strong class="me-auto">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastMessage"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script>
// Global variables for storing data
let hotelData = {
    hotels: [],
    rooms: [],
    dates: [],
    bookings: [],
    aggregatedBookings: []
};

let charts = {};

// Initialize the dashboard
document.addEventListener('DOMContentLoaded', async () => {
    showLoading();
    try {
        await loadAllData();
        initializeFilters();
        createCharts();
        updateDashboard();
        showFeedback('Dashboard loaded successfully!', 'success');
    } catch (error) {
        console.error('Error initializing dashboard:', error);
        showFeedback('Error loading dashboard. Please try again.', 'error');
    }
    hideLoading();
});

// Data Loading Functions
async function loadAllData() {
    const dataFiles = {
        hotels: 'data/dim_hotels.csv',
        rooms: 'data/dim_rooms.csv',
        dates: 'data/dim_date.csv',
        bookings: 'data/fact_bookings.csv',
        aggregatedBookings: 'data/fact_aggregated_bookings.csv'
    };

    for (const [key, file] of Object.entries(dataFiles)) {
        hotelData[key] = await loadCSV(file);
    }
}

async function loadCSV(file) {
    try {
        const response = await fetch(file);
        const csvText = await response.text();
        return parseCSV(csvText);
    } catch (error) {
        throw new Error(`Error loading ${file}: ${error.message}`);
    }
}

function parseCSV(csvText) {
    return new Promise((resolve, reject) => {
        Papa.parse(csvText, {
            header: true,
            dynamicTyping: true,
            complete: (results) => resolve(results.data),
            error: (error) => reject(error)
        });
    });
}

// Filter Initialization
function initializeFilters() {
    // Initialize City Filter
    const cities = [...new Set(hotelData.hotels.map(hotel => hotel.city))];
    populateFilter('cityFilter', cities);

    // Initialize Property Filter
    const properties = [...new Set(hotelData.hotels.map(hotel => hotel.property_name))];
    populateFilter('propertyFilter', properties);

    // Initialize Platform Filter
    const platforms = [...new Set(hotelData.bookings.map(booking => booking.booking_platform))];
    populateFilter('platformFilter', platforms);

    // Initialize Date Filter
    const months = [...new Set(hotelData.dates.map(date => date['mmm yy']))];
    populateFilter('dateFilter', months);

    // Add event listeners
    document.querySelectorAll('.form-select').forEach(select => {
        select.addEventListener('change', () => {
            updateDashboard();
        });
    });
}

function populateFilter(filterId, options) {
    const select = document.getElementById(filterId);
    options.forEach(option => {
        const opt = document.createElement('option');
        opt.value = option;
        opt.textContent = option;
        select.appendChild(opt);
    });
}

// KPI Calculations
function calculateKPIs(filteredData) {
    const kpis = {
        totalRevenue: calculateTotalRevenue(filteredData),
        occupancyRate: calculateOccupancyRate(filteredData),
        avgRating: calculateAverageRating(filteredData),
        cancellationRate: calculateCancellationRate(filteredData)
    };

    updateKPIDisplay(kpis);
    return kpis;
}

function calculateTotalRevenue(bookings) {
    return bookings.reduce((sum, booking) => sum + (booking.revenue_realized || 0), 0);
}

function calculateOccupancyRate(bookings) {
    const aggregated = hotelData.aggregatedBookings;
    const totalSuccessful = aggregated.reduce((sum, record) => sum + record.successful_bookings, 0);
    const totalCapacity = aggregated.reduce((sum, record) => sum + record.capacity, 0);
    return (totalSuccessful / totalCapacity) * 100;
}

function calculateAverageRating(bookings) {
    const validRatings = bookings.filter(booking => booking.ratings_given);
    return validRatings.reduce((sum, booking) => sum + booking.ratings_given, 0) / validRatings.length;
}

function calculateCancellationRate(bookings) {
    const totalBookings = bookings.length;
    const cancelledBookings = bookings.filter(booking => booking.booking_status === 'Cancelled').length;
    return (cancelledBookings / totalBookings) * 100;
}

// Chart Creation
function createCharts() {
    charts.revenueTrend = createRevenueTrendChart();
    charts.occupancy = createOccupancyChart();
    charts.platform = createPlatformChart();
    charts.rating = createRatingChart();
}

function createRevenueTrendChart() {
    const ctx = document.getElementById('revenueTrendChart').getContext('2d');
    return new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Revenue',
                data: [],
                borderColor: '#3498db',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

function createOccupancyChart() {
    const ctx = document.getElementById('occupancyChart').getContext('2d');
    return new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Occupancy Rate',
                data: [],
                backgroundColor: '#2ecc71'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

function createPlatformChart() {
    const ctx = document.getElementById('platformChart').getContext('2d');
    return new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: [
                    '#3498db',
                    '#2ecc71',
                    '#e74c3c',
                    '#f1c40f'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

function createRatingChart() {
    const ctx = document.getElementById('ratingChart').getContext('2d');
    return new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [1, 2, 3, 4, 5],
            datasets: [{
                label: 'Rating Distribution',
                data: [],
                backgroundColor: '#f1c40f'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

// Dashboard Updates
function updateDashboard() {
    const filteredData = filterData();
    calculateKPIs(filteredData);
    updateCharts(filteredData);
    updateTable(filteredData);
}

function filterData() {
    let filtered = [...hotelData.bookings];

    const cityFilter = document.getElementById('cityFilter').value;
    const propertyFilter = document.getElementById('propertyFilter').value;
    const platformFilter = document.getElementById('platformFilter').value;
    const dateFilter = document.getElementById('dateFilter').value;

    if (cityFilter !== 'all') {
        const propertyIds = hotelData.hotels
            .filter(hotel => hotel.city === cityFilter)
            .map(hotel => hotel.property_id);
        filtered = filtered.filter(booking => propertyIds.includes(booking.property_id));
    }

    if (propertyFilter !== 'all') {
        const propertyId = hotelData.hotels.find(hotel => hotel.property_name === propertyFilter)?.property_id;
        filtered = filtered.filter(booking => booking.property_id === propertyId);
    }

    if (platformFilter !== 'all') {
        filtered = filtered.filter(booking => booking.booking_platform === platformFilter);
    }

    if (dateFilter !== 'all') {
        filtered = filtered.filter(booking => {
            const bookingMonth = new Date(booking.booking_date).toLocaleString('en-US', { month: 'short' }) + '-' +
                               new Date(booking.booking_date).getFullYear().toString().slice(-2);
            return bookingMonth === dateFilter;
        });
    }

    return filtered;
}

function updateKPIDisplay(kpis) {
    document.getElementById('totalRevenue').textContent = `â‚¹${kpis.totalRevenue.toLocaleString()}`;
    document.getElementById('occupancyRate').textContent = `${kpis.occupancyRate.toFixed(1)}%`;
    document.getElementById('avgRating').textContent = kpis.avgRating.toFixed(1);
    document.getElementById('cancellationRate').textContent = `${kpis.cancellationRate.toFixed(1)}%`;
}

function updateCharts(filteredData) {
    updateRevenueTrendChart(filteredData);
    updateOccupancyChart(filteredData);
    updatePlatformChart(filteredData);
    updateRatingChart(filteredData);
}

function updateRevenueTrendChart(filteredData) {
    const revenueByDate = {};
    filteredData.forEach(booking => {
        const date = booking.booking_date;
        revenueByDate[date] = (revenueByDate[date] || 0) + booking.revenue_realized;
    });

    const sortedDates = Object.keys(revenueByDate).sort();
    charts.revenueTrend.data.labels = sortedDates;
    charts.revenueTrend.data.datasets[0].data = sortedDates.map(date => revenueByDate[date]);
    charts.revenueTrend.update();
}

function updateOccupancyChart(filteredData) {
    const occupancyByRoom = {};
    hotelData.aggregatedBookings.forEach(record => {
        occupancyByRoom[record.room_category] = (occupancyByRoom[record.room_category] || 0) +
            (record.successful_bookings / record.capacity) * 100;
    });

    charts.occupancy.data.labels = Object.keys(occupancyByRoom);
    charts.occupancy.data.datasets[0].data = Object.values(occupancyByRoom);
    charts.occupancy.update();
}

function updatePlatformChart(filteredData) {
    const platformCounts = {};
    filteredData.forEach(booking => {
        platformCounts[booking.booking_platform] = (platformCounts[booking.booking_platform] || 0) + 1;
    });

    charts.platform.data.labels = Object.keys(platformCounts);
    charts.platform.data.datasets[0].data = Object.values(platformCounts);
    charts.platform.update();
}

function updateRatingChart(filteredData) {
    const ratingCounts = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0};
    filteredData.forEach(booking => {
        if (booking.ratings_given) {
            ratingCounts[booking.ratings_given]++;
        }
    });

    charts.rating.data.datasets[0].data = Object.values(ratingCounts);
    charts.rating.update();
}

function updateTable(filteredData) {
    const tableBody = document.getElementById('statsTable');
    tableBody.innerHTML = '';

    const propertyStats = {};
    filteredData.forEach(booking => {
        if (!propertyStats[booking.property_id]) {
            propertyStats[booking.property_id] = {
                revenue: 0,
                bookings: 0,
                ratings: [],
                cancellations: 0
            };
        }
        
        const stats = propertyStats[booking.property_id];
        stats.revenue += booking.revenue_realized;
        stats.bookings++;
        if (booking.ratings_given) stats.ratings.push(booking.ratings_given);
        if (booking.booking_status === 'Cancelled') stats.cancellations++;
    });

    for (const [propertyId, stats] of Object.entries(propertyStats)) {
        const hotel = hotelData.hotels.find(h => h.property_id === propertyId);
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${hotel.property_name}</td>
            <td>â‚¹${stats.revenue.toLocaleString()}</td>
            <td>${((stats.bookings / filteredData.length) * 100).toFixed(1)}%</td>
            <td>${(stats.ratings.reduce((a, b) => a + b, 0) / stats.ratings.length).toFixed(1)}</td>
            <td>${((stats.cancellations / stats.bookings) * 100).toFixed(1)}%</td>
        `;
        tableBody.appendChild(row);
    }
}

// Utility Functions
function showLoading() {
    document.getElementById('loadingSpinner').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loadingSpinner').style.display = 'none';
}

function showFeedback(message, type) {
    const toast = document.getElementById('feedbackToast');
    const toastMessage = document.getElementById('toastMessage');
    toastMessage.textContent = message;
    toastMessage.className = `toast-body ${type}`;
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
}
</script>
</body>
</html>